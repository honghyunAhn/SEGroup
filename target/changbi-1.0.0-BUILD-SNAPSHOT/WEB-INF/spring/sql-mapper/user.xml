<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.aracomm.changbi.user.dao.UserDao">

	<select id="selectIpList" parameterType="string" resultType="hashmap">
		SELECT SEQ, IP
		  FROM CB_IP_ADDRESS
		 WHERE USER_ID = #{user_id}
	</select>

	<select id="selectUserIpCount" parameterType="map" resultType="int">
		SELECT IFNULL(COUNT(1), 0)
		  FROM CB_IP_ADDRESS
		 WHERE USER_ID = #{user_id}
		   AND IP = #{ip}
	</select>

	<update id="updateIpUseYn" parameterType="map">
		UPDATE CB_MEMBER
		<if test='ipchek == null'>
		SET IP_USE_YN = 'N'
		</if>
		<if test='ipchek == "Y"'>
		SET IP_USE_YN = 'Y'
		</if>
		WHERE ID = #{user_id}
	</update>

	<insert id="insertIp" parameterType="map">
		INSERT INTO CB_IP_ADDRESS (
			USER_ID
		  , IP
		  , REG_USER
		 ) VALUES (
		 	#{user_id}
		  , #{ip}
		  , #{user_id}
		 )
	</insert>

	<delete id="deleteIp" parameterType="map">
		DELETE FROM CB_IP_ADDRESS
		 WHERE SEQ = #{seq}
		   AND USER_ID = #{user_id}
	</delete>


	<select id="selectUserForLogin" resultType="hashmap">
		SELECT ID AS USER_ID, PW AS PASSWORD, AUTHORITY, NAME, EMAIL, SCHOOL_NAME, PHONE, IP_USE_YN, PW_INIT_YN
		  FROM CB_MEMBER
		WHERE ID = #{user_id}
		  AND USE_YN = 'Y'
	</select>

	<update id="updateLastLogin" parameterType="string">
	   	UPDATE CB_MEMBER
		   SET LAST_LOGIN = DATE_FORMAT(NOW(),'%Y%m%d%H%i%s')
		 WHERE ID = #{user_id}
	</update>

	<!-- 본인인증 DI로 사용자 조회 -->
	<select id="selectUserForLoginByIdenDi" parameterType="string" resultType="hashmap">
		SELECT ID AS USER_ID, PW AS PASSWORD, AUTHORITY, NAME, EMAIL, SCHOOL_NAME, PHONE, IP_USE_YN, PW_INIT_YN
		  FROM CB_MEMBER
		 WHERE IDEN_DI = NULLIF(#{iden_di},'')
		   AND USE_YN = 'Y'
	</select>

	<select id="selectUserNeisNum" parameterType="string" resultType="string">
		SELECT NEIS_NUM
		  FROM CB_MEMBER
		 WHERE ID = #{user_id}
	</select>


</mapper>